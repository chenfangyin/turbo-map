name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm run test:ci

      - name: Security check
        run: npm run security:check

      - name: Build project
        run: npm run build

      - name: Test build output
        run: |
          node -e "import('./dist/index.esm.js').then(m => { console.log('ESM build works'); });"
          node -e "import('./dist/index.js').then(m => { console.log('CommonJS build works'); });"

      - name: Validate package.json
        run: |
          echo "ğŸ” éªŒè¯ package.json é…ç½®..."
          echo "ğŸ“¦ åŒ…åç§°: $(node -p "require('./package.json').name")"
          echo "ğŸ“‹ ç‰ˆæœ¬: $(node -p "require('./package.json').version")"
          echo "ğŸ“ æè¿°: $(node -p "require('./package.json').description")"
          echo "ğŸ”— ä¸»é¡µ: $(node -p "require('./package.json').homepage")"
          echo "ğŸ“„ è®¸å¯è¯: $(node -p "require('./package.json').license")"
          echo "ğŸ‘¤ ä½œè€…: $(node -p "require('./package.json').author")"
          
          # éªŒè¯å¿…éœ€å­—æ®µ
          if [ -z "$(node -p "require('./package.json').name")" ]; then
            echo "âŒ ç¼ºå°‘åŒ…åç§°"
            exit 1
          fi
          
          if [ -z "$(node -p "require('./package.json').version")" ]; then
            echo "âŒ ç¼ºå°‘ç‰ˆæœ¬å·"
            exit 1
          fi
          
          if [ -z "$(node -p "require('./package.json').description")" ]; then
            echo "âŒ ç¼ºå°‘æè¿°"
            exit 1
          fi
          
          echo "âœ… package.json éªŒè¯é€šè¿‡"

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level=moderate

      - name: Check for known vulnerabilities
        run: npm audit --audit-level=high

  bundle-size:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check bundle size
        run: |
          echo "Bundle sizes:"
          ls -la dist/
          echo "UMD bundle size:"
          wc -c < dist/index.umd.min.js | numfmt --to=iec
          echo "ESM bundle size:"
          wc -c < dist/index.esm.js | numfmt --to=iec

  performance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Notify on failure (Slack)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          channel: "#ci-cd"
          username: "CI/CD Bot"
          icon_emoji: ":warning:"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify on failure (Discord)
        if: failure()
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -H "Content-Type: application/json" \
                 -d '{
                   "embeds": [{
                     "title": "âŒ CI/CD Pipeline Failed",
                     "description": "The CI/CD pipeline for turbo-map has failed.",
                     "color": 15158332,
                     "fields": [
                       {
                         "name": "Repository",
                         "value": "${{ github.repository }}",
                         "inline": true
                       },
                       {
                         "name": "Branch",
                         "value": "${{ github.ref_name }}",
                         "inline": true
                       },
                       {
                         "name": "Commit",
                         "value": "${{ github.sha }}",
                         "inline": true
                       }
                     ],
                     "timestamp": "${{ github.event.head_commit.timestamp }}"
                   }]
                 }' \
                 "${{ secrets.DISCORD_WEBHOOK_URL }}"
            echo "âœ… Discord failure notification sent"
          else
            echo "â„¹ï¸ Discord webhook not configured, skipping failure notification"
          fi
        continue-on-error: true

      - name: Notify on success (Discord)
        if: success()
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -H "Content-Type: application/json" \
                 -d '{
                   "embeds": [{
                     "title": "âœ… CI/CD Pipeline Succeeded",
                     "description": "The CI/CD pipeline for turbo-map has completed successfully.",
                     "color": 3066993,
                     "fields": [
                       {
                         "name": "Repository",
                         "value": "${{ github.repository }}",
                         "inline": true
                       },
                       {
                         "name": "Branch",
                         "value": "${{ github.ref_name }}",
                         "inline": true
                       },
                       {
                         "name": "Commit",
                         "value": "${{ github.sha }}",
                         "inline": true
                       }
                     ],
                     "timestamp": "${{ github.event.head_commit.timestamp }}"
                   }]
                 }' \
                 "${{ secrets.DISCORD_WEBHOOK_URL }}"
            echo "âœ… Discord success notification sent"
          else
            echo "â„¹ï¸ Discord webhook not configured, skipping success notification"
          fi
        continue-on-error: true
